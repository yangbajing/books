# gRPC 微服务的收益

在典型的单体应用中，调用不同的业务活动，例如从结账服务调用支付服务，意味着访问一个单独模块中的类方法，这非常简单。如果使用微服务，这些调用将转换为网络通信。这可以是 TCP、HTTP 或事件队列调用，以在服务之间交换数据。处理网络调用比调用另一个类方法更具挑战性，后者可以通过简单的错误处理机制如 try-catch 块来管理。即使单体应用一开始也很容易使用，但出于多种原因，您可能需要对其进行拆分，包括缓慢的部署和低效的资源利用，这会影响功能开发和产品维护。这并不意味着单体应用不好，微服务就好；微服务也带来了挑战，我们将在第二章中详细讨论。在 gRPC 的帮助下，微服务中的大多数挑战，例如处理网络故障和将 TLS（传输层安全性）应用于服务通信（见第六章），都可以消除。 通过使用 gRPC 中的这些内置功能，可以提高产品的可靠性和整个团队的生产力。

## 性能

gRPC 提供比其他协议更好的性能和安全性，例如使用 JSON 或 XML 通信的 REST，因为它使用 `protobuf` ，并且在 TLS 上使用 HTTP/2 非常简单。 `protobuf` ，也称为 Protobuf，是一种语言和平台中立的结构化数据序列化机制，您将在第 3 章中详细了解。这种机制使 gRPC 能够快速将消息序列化为小而紧凑的消息，适用于服务器和客户端。在同样的方式下，HTTP/2 通过服务器推送、多路复用和头部压缩来提升性能，我们将在第 5 章中更详细地讨论。

## 代码生成与互操作性

假设您有一个结账服务和一个支付服务，允许客户结账一个购物篮，然后触发支付服务调用以支付购物篮中的产品。要访问支付服务，您需要在某个地方（例如共享库）拥有请求和响应模型，以便轻松访问它们。在微服务中重用共享请求和响应模型似乎很方便，但这并不是一个好的实践，特别是当您为每个微服务使用不同的语言时。在结账服务中复制模型，通常通过创建另一个数据类来构建请求对象并将响应对象反序列化，是一个更好的选择。这一切都是为了防止错误的抽象，正如您可能已经听过的那句话：“一点重复远比错误的抽象便宜”。还有一种更简单的方法：选择 gRPC 来定义您的消息并生成客户端存根，以便您可以注入这个依赖并在您喜欢的任何语言中直接使用它。我们将在第 3 更深入的讨论代码生成。

gRPC 工具和库与多个平台和语言兼容，包括 Rust、Go、Java、Python、Typescript/Javascript、C# 等。Protobuf 二进制 wire 格式在网络中传输时，以及几乎所有平台的良好代码生成，使开发人员能够构建性能关键的应用程序，同时保留跨平台支持。我们将在第 3 章中详细了解 Protobuf 在服务间通信中表现良好的原因。

gRPC 正在变得越来越流行（https://star-history.com/#grpc/grpc&Date），因为您可以快速生成客户端存根，以在不同语言中提供服务的 SDK。您只需决定需要哪些业务对象。一旦选择了结账模型所需的字段，就可以引入相应的请求和响应消息。请记住，这些消息只是 IDL（接口定义语言）中的定义，与任何语言规范无关。在定义消息规范后，您可以生成特定语言的实现，以便任何消费者都可以依赖该源。这也意味着服务器端的开发语言可以与客户端不同，因为服务器端的方法可以作为存根在客户端生成，以支持 gRPC 的特定语言。

除了业务对象，您还可以类似地定义服务方法并生成实现。这些服务函数可以在您初始化消费者端的 gRPC 客户端后调用；同样，这个客户端是开箱即用生成的。

## 容错性

容错是系统在发生故障时继续运行的能力。幂等操作即使被调用多次也没有额外的效果。幂等性是成功的容错环境的关键，因为您需要确保在发生故障或未达到预期状态的情况下，重新尝试使用相同参数的操作不会改变实际资源的内容。例如，我们可能希望在响应时发生网络故障的情况下重试用户删除操作。如果该操作即使被调用多次也返回相同的结果，我们称该操作为幂等的。

如果一个操作不适合幂等性用例，您必须在响应消息中提供适当的验证错误，以帮助您知道何时停止重试操作。一旦您保证了这种幂等性或适当的验证，这只是 gRPC 端重试策略的定义。容错还关注诸如速率限制、断路器和故障注入等主题，我们将在第六章中更详细地讨论这些内容。

## 安全

在大多数系统中，您可能需要一个安全层来保护您的产品免受未验证来源的攻击。gRPC 鼓励使用 SSL/TLS 上的 HTTP/2 来验证和加密客户端与服务器之间交换的数据。更具体地说，您可以轻松地使用 SSL/TLS、ALTS（应用层传输安全）或基于令牌的身份验证系统来设置该身份验证系统，我们将在第六章中详细介绍。

## 流式传输（Streaming）

有时您可能需要以分页的方式将响应数据分成几个块，以减少带宽并快速返回给用户。此外，如果用户只对特定页面感兴趣，同时返回所有数据是没有意义的。在 gRPC 中，除了分页，您还可以将这些数据流式传输给消费者，而不是强迫用户进行分页以迭代获取数据。流式传输不一定要在服务器端；它也可以在客户端，或者同时在双方进行，称为双向流式传输。在典型的流式传输用例中，您只需打开一次连接，数据就会通过这个打开的连接进行流式传输。您将在本书中看到不同类型的流式传输用例，特别是在第 5 章中，当我们实现一个完整的应用程序时。
